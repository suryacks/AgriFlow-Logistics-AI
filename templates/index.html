<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriFlow V3.3: Logistics-to-Alpha</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }

        .neon-green {
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

        .neon-blue {
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.5);
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Loading Button Animation */
        .loading-btn {
            position: relative;
            overflow: hidden;
            pointer-events: none;
            color: transparent !important;
            /* Hide original text */
        }

        .loading-btn::after {
            content: "PROCESSING DATA...";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: 800;
            font-size: 11px;
            letter-spacing: 1px;
            z-index: 2;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .loading-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            /* Cleaner Gradient */
            background: linear-gradient(90deg, #059669, #10b981);
            width: 0%;
            animation: loadBar 3s ease-in-out forwards;
            z-index: 1;
        }

        @keyframes loadBar {
            0% {
                width: 0%;
            }

            20% {
                width: 10%;
            }

            50% {
                width: 40%;
            }

            80% {
                width: 80%;
            }

            95% {
                width: 95%;
            }

            100% {
                width: 95%;
            }

            /* Stalls at 95 until done */
        }

        /* Flow Animation */
        .flow-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .data-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22d3ee;
            box-shadow: 0 0 10px #22d3ee;
            animation: flowPath 4s infinite linear;
        }

        @keyframes flowPath {
            0% {
                top: 10%;
                left: 10%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            40% {
                top: 50%;
                left: 50%;
            }

            80% {
                top: 80%;
                left: 80%;
                opacity: 1;
            }

            100% {
                top: 90%;
                left: 90%;
                opacity: 0;
            }
        }
    </style>
</head>

<body
    class="min-h-screen overflow-y-auto bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-black">

    <!-- Top Nav -->
    <nav class="absolute top-0 w-full p-6 flex justify-between items-center z-50">
        <div class="flex items-center space-x-3">
            <div
                class="w-8 h-8 rounded bg-gradient-to-br from-green-500 to-cyan-500 flex items-center justify-center font-bold text-black">
                A</div>
            <h1 class="text-xl font-bold tracking-widest">AGRI<span class="text-green-400">FLOW</span></h1>
        </div>
        <div class="flex space-x-1 bg-slate-800/50 p-1 rounded-lg backdrop-blur">
            <button onclick="setMode('logistics')" id="btnLogistics"
                class="px-4 py-2 text-xs font-bold rounded bg-slate-700 text-white shadow transition-all">LOGISTICS
                TWIN</button>
            <button onclick="setMode('alpha')" id="btnAlpha"
                class="px-4 py-2 text-xs font-bold rounded text-slate-400 hover:text-white transition-all">ALPHA
                PREDATOR</button>
            <button onclick="setMode('internals')" id="btnInternals"
                class="px-4 py-2 text-xs font-bold rounded text-slate-400 hover:text-white transition-all">SYSTEM
                INTERNALS</button>
            <button onclick="toggleModal('modalSources')"
                class="px-4 py-2 text-xs font-bold rounded text-slate-400 hover:text-cyan-400 transition-all border-l border-slate-700 ml-2 pl-4"><i
                    class="fas fa-database mr-1"></i> DATA SOURCES</button>
            <button onclick="setMode('l2l')" id="btnL2L"
                class="px-4 py-2 text-xs font-bold rounded text-slate-400 hover:text-orange-400 transition-all border-l border-slate-700 ml-2 pl-4"><i
                    class="fas fa-flask mr-1"></i> L2L LAB</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="min-h-screen pt-20 pb-6 px-10 grid grid-cols-12 gap-10">

        <!-- Sidebar: Configuration -->
        <div id="sidebarContainer"
            class="glass-dark col-span-3 p-6 flex flex-col h-full transition-all duration-300 ease-in-out">
            <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-6">Mission Control</h2>

            <!-- LOGISTICS CONTROLS -->
            <div id="ctrlLogistics" class="space-y-8 animate-fade-in">
                <div>
                    <label class="text-xs text-green-400 uppercase font-bold">Fleet Capacity</label>
                    <input type="range" id="fleetSize" min="10" max="200" value="50"
                        class="w-full mt-2 accent-green-500 h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-xs text-slate-400 mt-1"><span>10</span><span id="fleetLabel"
                            class="text-white">50 Trucks</span><span>200</span></div>
                </div>
                <div>
                    <label class="text-xs text-red-400 uppercase font-bold">Traffic Entropy</label>
                    <input type="range" id="trafficProb" min="0" max="0.5" step="0.05" value="0.1"
                        class="w-full mt-2 accent-red-500 h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer">
                    <div class="text-right text-xs text-white mt-1" id="trafficLabel">10% Chaos</div>
                </div>
                <div>
                    <label class="text-xs text-yellow-500 uppercase font-bold">Thermal Stress</label>
                    <input type="range" id="heatFactor" min="0" max="1.0" step="0.1" value="0.5"
                        class="w-full mt-2 accent-yellow-500 h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer">
                    <div class="text-right text-xs text-white mt-1" id="heatLabel">50% Intensity</div>
                </div>
                <button onclick="runFleetSim()"
                    class="w-full py-3 bg-green-600 hover:bg-green-500 text-black font-bold tracking-tight rounded shadow-[0_0_20px_rgba(74,222,128,0.3)] transition-all">
                    INITIATE FLEET SIMULATOR
                </button>
            </div>

            <!-- ALPHA CONTROLS -->
            <div id="ctrlAlpha" class="hidden space-y-6">
                <div>
                    <label class="text-xs text-cyan-400 uppercase font-bold">Target Asset</label>
                    <select id="ticker"
                        class="w-full mt-2 bg-slate-900 border border-slate-700 rounded p-2 text-sm focus:border-cyan-500 outline-none">
                        <option value="DC=F">Class III Milk (Futures)</option>
                        <option value="ZC=F">Corn (Futures)</option>
                        <option value="ZS=F">Soybeans (Futures)</option>
                        <option value="LE=F">Live Cattle (Futures)</option>
                    </select>
                </div>
                <div class="border-t border-slate-800 pt-4">
                    <h3 class="text-xs font-bold text-white mb-3">Analysis Mode</h3>
                    <div class="mb-6">
                        <label class="text-xs text-slate-500 uppercase">Time Machine (Predict One Event)</label>
                        <div class="flex flex-col space-y-2 mt-1">
                            <input type="date" id="predictDate" value="2024-01-16"
                                class="bg-slate-900 border border-slate-700 rounded p-2 text-xs w-full text-white">
                            <button onclick="runPrediction()"
                                class="w-full py-2 bg-cyan-600 hover:bg-cyan-500 text-black text-xs font-bold rounded shadow transition-all flex justify-center items-center">
                                <i class="fas fa-bolt mr-2"></i> GENERATE PREDICTION
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 uppercase">Quarterly Simulation</label>
                        <button id="btnBacktest" onclick="runBacktest()"
                            class="w-full mt-2 py-3 border border-slate-700 hover:border-cyan-500 text-slate-300 hover:text-white text-xs font-bold rounded transition-all flex justify-center items-center space-x-2 relative">
                            <span>RUN Q1 2024 BACKTEST</span>
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- INTERNALS INFO -->
            <div id="ctrlInternal" class="hidden text-xs text-slate-400">
                <p>Visualizing the data pipeline from Satellite Ingestion to Alpha Signal Generation.</p>
            </div>

            <!-- System Status -->
            <div class="mt-auto pt-6 border-t border-slate-800">
                <div class="flex items-center space-x-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-xs font-bold text-slate-600 uppercase">System Online</span>
                </div>
            </div>
        </div>

        <!-- Main Display Area -->
        <div id="mainContentContainer"
            class="col-span-9 grid grid-rows-1 h-full gap-6 transition-all duration-300 ease-in-out">

            <!-- VIEW: LOGISTICS -->
            <div id="viewLogistics" class="h-full flex flex-col space-y-6">
                <div class="grid grid-cols-3 gap-6 h-32">
                    <div class="glass-dark p-4 flex flex-col justify-center border-l-2 border-slate-700">
                        <span class="text-xs text-slate-500 uppercase font-bold">Legacy Cost (High)</span>
                        <span id="sapVal" class="text-2xl font-mono text-slate-300 mt-1">--</span>
                    </div>
                    <div class="glass-dark p-4 flex flex-col justify-center border-l-2 border-green-500 bg-green-500/5">
                        <span class="text-xs text-green-400 uppercase font-bold">AgriFlow Cost (Low)</span>
                        <span id="aiVal" class="text-3xl font-mono text-white mt-1 neon-green">--</span>
                    </div>
                    <div class="glass-dark p-4 flex flex-col justify-center">
                        <span class="text-xs text-slate-500 uppercase font-bold">Cost Reduction</span>
                        <span id="gainVal" class="text-2xl font-bold text-white mt-1">--</span>
                    </div>
                </div>
                <div class="glass-dark flex-1 p-4 relative">
                    <canvas id="logisticsChart"></canvas>
                </div>
            </div>

            <!-- VIEW: ALPHA (Split Views) -->
            <div id="viewAlpha" class="hidden grid grid-cols-12 gap-8 p-6">
                <!-- Left Column: Prediction & Controls -->
                <div class="col-span-12 xl:col-span-3 flex flex-col space-y-4">

                    <!-- Single Event Card (Expandable) -->
                    <div id="cardSingleEvent"
                        class="glass-dark flex flex-col relative overflow-hidden transition-all duration-500 ease-in-out h-[640px] z-40">
                        <div class="p-4 flex-1 flex flex-col">
                            <!-- Header -->
                            <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                                <h3 class="text-xs font-bold text-white uppercase tracking-wider"><i
                                        class="fas fa-bolt text-cyan-400 mr-2"></i>Alpha Predictor</h3>
                                <button onclick="toggleFullscreen()"
                                    class="text-slate-500 hover:text-white transition-colors"><i
                                        class="fas fa-expand"></i></button>
                            </div>

                            <!-- INPUT AREA (Visible when empty) -->
                            <div id="predEmpty" class="flex-1 flex flex-col items-center justify-center space-y-4">
                                <div
                                    class="w-20 h-20 rounded-full bg-slate-800/50 border border-slate-700 flex items-center justify-center relative">
                                    <i class="fas fa-search-dollar text-3xl text-slate-500"></i>
                                    <div
                                        class="absolute inset-0 border-2 border-cyan-500/20 rounded-full animate-ping-slow">
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 uppercase tracking-widest">Select Date & Generate
                                </p>
                            </div>

                            <!-- RESULT AREA (Hidden by default) -->
                            <div id="predResult"
                                class="hidden flex-1 flex flex-col space-y-2 overflow-y-auto custom-scrollbar">
                                <!-- Verdict Badge -->
                                <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded">
                                    <div class="text-xs text-slate-400">TARGET DATE: <span id="resDate"
                                            class="text-white font-bold ml-1">--</span></div>
                                    <div id="resVerdict"
                                        class="px-2 py-0.5 bg-slate-700 text-xs uppercase font-bold text-white rounded">
                                        PENDING</div>
                                </div>

                                <!-- Main Price Grid -->
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-black/20 p-2 rounded border border-slate-700/50">
                                        <div class="text-xs text-cyan-400 font-bold uppercase">Predicted</div>
                                        <div id="resPred" class="text-xl font-bold text-white my-1">--</div>
                                        <div class="text-xs text-slate-500">Error: <span id="resDelta"
                                                class="text-slate-300">--</span></div>
                                    </div>
                                    <div class="bg-black/20 p-2 rounded border border-slate-700/50">
                                        <div class="text-xs text-yellow-400 font-bold uppercase">Actual</div>
                                        <div id="resAct" class="text-xl font-bold text-slate-200 my-1">--</div>
                                        <div id="resMove" class="text-xs text-slate-500 uppercase leading-tight">--
                                        </div>
                                    </div>
                                </div>

                                <!-- CAPITAL ALLOCATION -->
                                <div class="border-t border-slate-700/50 pt-2 mt-2">
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="text-xs text-slate-400 uppercase font-bold">Capital
                                            Allocation</label>
                                        <span id="capitalLabel" class="text-xs text-cyan-400 font-mono">$10,000</span>
                                    </div>
                                    <input type="range" id="capitalSlider" min="1000" max="100000" step="1000"
                                        value="10000"
                                        class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                                        oninput="updateProfitCalc()">
                                </div>

                                <!-- PROFIT PROJECTION -->
                                <div
                                    class="bg-gradient-to-r from-green-900/40 to-slate-800/40 p-3 rounded border border-green-500/30 mt-2">
                                    <div class="flex justify-between items-center">
                                        <div class="flex flex-col">
                                            <span
                                                class="text-xs text-green-400 font-bold uppercase tracking-widest">Potential
                                                Profit</span>
                                            <span id="projProfit"
                                                class="text-xl font-bold text-white font-mono">$0</span>
                                        </div>
                                        <div class="text-right">
                                            <div
                                                class="bg-green-500 text-black text-xs font-bold px-1 rounded inline-block mb-1">
                                                CONFIDENCE: <span id="confScore">--</span></div>
                                            <div class="text-xs text-slate-400">Lev: <span id="levBadge"
                                                    class="text-white font-bold">--</span>x</div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-800 h-1 mt-2 rounded-full overflow-hidden">
                                        <div id="alphaWindowBar"
                                            class="bg-yellow-400 h-full w-0 transition-all duration-1000"></div>
                                    </div>
                                    <div class="text-xs text-yellow-400 text-center mt-1">ALPHA WINDOW: <span
                                            id="winHours">--</span> HRS</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Proprietary Signals Grid -->
                    <div class="border-t border-slate-700/50 pt-2 mt-1">
                        <h4 class="text-xs text-purple-400 font-bold uppercase mb-2 flex items-center justify-center">
                            <i class="fas fa-satellite-dish mr-1"></i> Live Logistics Signals
                        </h4>
                        <div class="grid grid-cols-3 gap-1">
                            <div class="bg-slate-800 p-1.5 rounded text-center">
                                <div class="text-xs text-slate-500 uppercase">Fleet</div>
                                <div id="resIoT" class="text-xs font-mono font-bold text-white">--</div>
                            </div>
                            <div class="bg-slate-800 p-1.5 rounded text-center">
                                <div class="text-xs text-slate-500 uppercase">Port</div>
                                <div id="resPort" class="text-xs font-mono font-bold text-white">--</div>
                            </div>
                            <div class="bg-slate-800 p-1.5 rounded text-center">
                                <div class="text-xs text-slate-500 uppercase">Stress</div>
                                <div id="resBreakage" class="text-xs font-mono font-bold text-white">--
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Provenance Footer -->
                    <div id="provenanceBadge"
                        class="flex justify-between items-center px-1 py-1 mt-1 bg-black/40 rounded border border-slate-800 hidden">
                        <span class="text-xs text-green-500 font-mono"><i class="fas fa-check mr-1"></i><span
                                id="srcMarket" class="text-slate-400">Verifying...</span></span>
                        <span class="text-xs text-green-500 font-mono"><i class="fas fa-check mr-1"></i><span
                                id="srcWeather" class="text-slate-400">Verifying...</span></span>
                    </div>

                    <!-- Intraday Chart -->
                    <div id="hourlyResult" class="flex-1 min-h-[180px] relative border-t border-slate-700/50 mt-2 pt-2">
                        <h5 class="text-xs text-slate-500 uppercase absolute top-2 left-0 z-10">High-Freq
                            Confidence Band</h5>
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>



        <!-- Right Column: Charts -->
        <div id="chartsColumn" class="col-span-12 xl:col-span-9 flex flex-col space-y-4">

            <!-- STATS DASHBOARD (OpenClaw Style) -->
            <div id="statsDashboard" class="grid grid-cols-4 gap-4 hidden">
                <div class="glass-dark p-4 border border-slate-700/50 rounded flex flex-col justify-between">
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Current Balance</div>
                    <div id="statBalance" class="text-2xl font-mono font-bold text-white">$10,000.00</div>
                </div>
                <div class="glass-dark p-4 border border-slate-700/50 rounded flex flex-col justify-between">
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Total P&L</div>
                    <div id="statPnL" class="text-2xl font-mono font-bold text-green-400">+$0.00</div>
                    <div id="statRoi" class="text-xs font-mono text-green-500/80">+0.0%</div>
                </div>
                <div class="glass-dark p-4 border border-slate-700/50 rounded flex flex-col justify-between">
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Win Rate</div>
                    <div id="statWinRate" class="text-2xl font-mono font-bold text-white">0.0%</div>
                    <div id="statTrades" class="text-xs text-slate-500">0 Trades</div>
                </div>
                <div class="glass-dark p-4 border border-slate-700/50 rounded flex flex-col justify-between">
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Sharpe (Est)</div>
                    <div id="statSharpe" class="text-2xl font-mono font-bold text-purple-400">--</div>
                    <div class="text-xs text-slate-500">Risk Adj. Return</div>
                </div>
            </div>

            <!-- Top Chart: Returns / Equity -->
            <div id="cardEquity"
                class="glass-dark p-4 relative flex flex-col h-[600px] transition-all duration-500 ease-in-out z-30">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-cyan-400 uppercase"><i
                            class="fas fa-chart-line mr-2"></i>Algorithm Equity Curve</h4>
                    <button onclick="toggleChartFullscreen('cardEquity', 'equityChart')"
                        class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-expand"></i></button>
                </div>
                <div class="flex-1 relative w-full h-full">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
            <!-- Bottom Chart: Prediction vs Actual -->
            <div id="cardPrice"
                class="glass-dark p-4 relative flex flex-col h-[600px] transition-all duration-500 ease-in-out z-30">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-yellow-400 uppercase"><i class="fas fa-chart-bar mr-2"></i>Price
                        Action: Predicted vs Actual</h4>
                    <button onclick="toggleChartFullscreen('cardPrice', 'priceChart')"
                        class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-expand"></i></button>
                </div>
                <div class="flex-1 relative w-full h-full">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- Trade Log Table -->
            <div id="cardTradeLog" class="glass-dark p-4 flex flex-col h-[300px] hidden">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2"><i class="fas fa-list mr-2"></i>Live Trade
                    Activity Log</h4>
                <div class="flex-1 overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-xs text-slate-500 uppercase sticky top-0 bg-[#0f172a] z-10">
                            <tr>
                                <th class="p-2">Date</th>
                                <th class="p-2">Type</th>
                                <th class="p-2">Price</th>
                                <th class="p-2">P&L</th>
                                <th class="p-2">ROI</th>
                            </tr>
                        </thead>
                        <tbody id="tradeLogBody" class="text-xs font-mono text-slate-300">
                            <!-- Rows Injected Here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>

        <!-- VIEW: L2L LAB -->
        <div id="viewL2L" class="h-full hidden flex flex-col space-y-4 pt-4 px-6 relative z-10">
            <div class="flex justify-between items-center bg-black/40 p-3 rounded border border-slate-700">
                <h2 class="text-xl font-bold text-white uppercase tracking-widest flex items-center"><i
                        class="fas fa-chess-board text-orange-500 mr-3"></i> Legacy L2L Agent Playground</h2>
                <div class="flex space-x-2">
                    <button onclick="clearL2L()"
                        class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-xs text-white rounded">Reset Grid</button>
                    <button onclick="runL2L()"
                        class="px-3 py-1 bg-orange-600 hover:bg-orange-500 text-xs text-black font-bold rounded shadow-lg shadow-orange-500/20">RUN
                        AGENT</button>
                </div>
            </div>

            <div class="flex-1 flex gap-6 h-full">
                <!-- CONTROLS -->
                <div class="w-80 glass-dark p-6 flex flex-col space-y-6">
                    <p class="text-xs text-slate-400 leading-relaxed">
                        Interact with the <strong>Reinforcement Learning (RL)</strong> Agent.
                        Click on the grid to place <span class="text-red-400 font-bold">Obstacles</span>.
                        The Agent will recalculate the optimal path using its Policy Network.
                    </p>

                    <div class="bg-black/30 p-4 rounded border border-slate-700/50">
                        <h3 class="text-xs text-slate-500 uppercase font-bold mb-2">Agent Stats</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs"><span class="text-slate-400">Status</span> <span
                                    id="l2lStatus" class="text-green-400 font-bold">IDLE</span></div>
                            <div class="flex justify-between text-xs"><span class="text-slate-400">Path Cost</span>
                                <span id="l2lCost" class="text-white font-mono">0</span>
                            </div>
                            <div class="flex justify-between text-xs"><span class="text-slate-400">Nodes Scanned</span>
                                <span id="l2lScanned" class="text-white font-mono">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GRID CANVAS -->
                <div class="flex-1 glass-dark p-4 flex items-center justify-center bg-black/50 relative">
                    <canvas id="l2lCanvas" width="600" height="600"
                        class="border border-slate-700 cursor-crosshair rounded bg-[#0f172a] shadow-2xl"></canvas>

                    <!-- Legend -->
                    <div
                        class="absolute bottom-4 left-4 flex space-x-4 bg-black/80 p-2 rounded backdrop-blur border border-slate-700">
                        <div class="flex items-center text-xs text-slate-300"><span
                                class="w-3 h-3 bg-green-500 mr-1 rounded-sm"></span> Start</div>
                        <div class="flex items-center text-xs text-slate-300"><span
                                class="w-3 h-3 bg-blue-500 mr-1 rounded-sm"></span> End</div>
                        <div class="flex items-center text-xs text-slate-300"><span
                                class="w-3 h-3 bg-red-500 mr-1 rounded-sm"></span> Barrier</div>
                        <div class="flex items-center text-xs text-slate-300"><span
                                class="w-3 h-3 bg-orange-400 mr-1 rounded-sm"></span> Path</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: INTERNALS (Data Pipeline Architecture) -->
        <div id="viewInternals" class="min-h-screen hidden bg-[#0B0F19] p-6 relative">
            <!-- BACKGROUND & DECORATION -->
            <div class="absolute inset-0 z-0 opacity-10 pointer-events-none"
                style="background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 20px 20px;">
            </div>

            <div class="relative z-10 h-full flex flex-col">
                <!-- Header -->
                <div class="mb-4 flex justify-between items-center px-4">
                    <div>
                        <h2 class="text-xl font-bold text-white uppercase tracking-widest"><i
                                class="fas fa-network-wired text-cyan-400 mr-2"></i>AgriFlow Intelligence</h2>
                        <p class="text-slate-500 text-xs mt-1">Live Data Lineage Map</p>
                    </div>
                    <div class="flex space-x-4 text-xs text-slate-400 uppercase">
                        <div class="flex items-center"><span
                                class="w-2 h-2 rounded-full bg-green-500 mr-1 animate-pulse"></span> Ingest Active
                        </div>
                        <div class="flex items-center"><span class="w-2 h-2 rounded-full bg-purple-500 mr-1"></span>
                            Simulation Running</div>
                    </div>
                </div>

                <!-- PIPELINE FLEX CONTAINER (Fit-to-Screen) -->
                <div class="flex-1 grid grid-cols-1 md:grid-cols-4 gap-8 px-4 w-full">

                    <!-- 1. SOURCE CLUSTER -->
                    <div class="flex flex-col space-y-4">
                        <h3 class="text-xs text-slate-500 font-bold uppercase text-center mb-2">Data Ingestion
                        </h3>

                        <!-- Card 1 -->
                        <div class="glass-dark p-3 border-l-2 border-green-500">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-green-400 font-bold">MARKET</span>
                                <i class="fas fa-chart-line text-slate-500 text-xs"></i>
                            </div>
                            <div class="text-xs text-white">NYSE/CME Feed</div>
                            <div class="text-xs text-slate-500 mt-1">Tick-Level • ~50ms</div>
                        </div>

                        <!-- Card 2 -->
                        <div class="glass-dark p-3 border-l-2 border-cyan-500">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-cyan-400 font-bold">WEATHER</span>
                                <i class="fas fa-cloud text-slate-500 text-xs"></i>
                            </div>
                            <div class="text-xs text-white">NASA / ERA5</div>
                            <div class="text-xs text-slate-500 mt-1">Global Precip • NetCDF</div>
                        </div>

                        <!-- Card 3 -->
                        <div class="glass-dark p-3 border-l-2 border-purple-500">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-purple-400 font-bold">SOCIAL</span>
                                <i class="fas fa-hashtag text-slate-500 text-xs"></i>
                            </div>
                            <div class="text-xs text-white">Facility Watch</div>
                            <div class="text-xs text-slate-500 mt-1">Reddit PRAW • 15m Poll</div>
                        </div>

                        <!-- Card 4: CV Vision (New) -->
                        <div class="glass-dark p-3 border-l-2 border-yellow-500 relative overflow-hidden group">
                            <div class="absolute inset-0 bg-black/50 z-0">
                                <div class="absolute top-2 right-2 flex items-center space-x-1 z-20">
                                    <span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span>
                                    <span class="text-xs font-bold text-red-500 uppercase">LIVE REC</span>
                                </div>
                            </div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs text-yellow-400 font-bold">TRAFFIC VISION</span>
                                    <i class="fas fa-video text-slate-500 text-xs"></i>
                                </div>
                                <div class="text-xs text-white">I-80 Des Moines CAM-04</div>
                                <div class="text-xs text-slate-500 mt-1">YOLOv8 • 30fps • <span
                                        class="text-green-400">98% Conf</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- ARROW 1 -->
                    <div class="flex flex-col items-center justify-center">
                        <div class="h-[2px] w-8 bg-slate-700"></div>
                        <i class="fas fa-chevron-right text-slate-500"></i>
                    </div>

                    <!-- 2. SIMULATION ENGINE (Centerpiece) -->
                    <div class=" flex flex-col justify-center">
                        <h3 class="text-xs text-slate-500 font-bold uppercase text-center mb-2">Physics Twin
                        </h3>

                        <div
                            class="bg-slate-900/80 border border-slate-700 p-6 rounded-xl relative overflow-hidden group hover:border-purple-500 transition-colors">
                            <!-- Animated Pulse Background -->
                            <div
                                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-purple-500/10 rounded-full blur-xl animate-pulse">
                            </div>

                            <div class="relative z-10 text-center">
                                <i class="fas fa-truck-moving text-3xl text-purple-400 mb-3"></i>
                                <h4 class="text-lg font-bold text-white">HOS Domino Engine</h4>
                                <p class="text-xs text-slate-400 font-mono mt-1">Discrete Event Sim (SimPy)</p>

                                <div class="mt-4 grid grid-cols-2 gap-2">
                                    <div class="bg-black/40 p-2 rounded">
                                        <div class="text-xs text-slate-500">NODES</div>
                                        <div class="text-xs text-white font-mono">548</div>
                                    </div>
                                    <div class="bg-black/40 p-2 rounded">
                                        <div class="text-xs text-slate-500">ROUTES</div>
                                        <div class="text-xs text-white font-mono">2,403</div>
                                    </div>
                                </div>
                                <div
                                    class="mt-2 bg-black/40 p-2 rounded flex justify-between items-center text-xs border border-orange-500/20">
                                    <div class="text-xs text-slate-500">LEGACY CORE</div>
                                    <div class="text-orange-400 font-mono font-bold flex items-center text-xs"><i
                                            class="fas fa-microchip mr-1"></i> L2L AGENT ONLINE</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ARROW 2 -->
                <div class="flex flex-col items-center justify-center">
                    <div class="h-[2px] w-8 bg-slate-700"></div>
                    <i class="fas fa-chevron-right text-slate-500"></i>
                </div>

                <!-- 3. ALPHA GENERATION -->
                <div class=" flex flex-col justify-center">
                    <h3 class="text-xs text-slate-500 font-bold uppercase text-center mb-2">Alpha Signal
                    </h3>

                    <div
                        class="bg-gradient-to-br from-slate-900 to-black border border-cyan-500/50 p-6 rounded-xl text-center shadow-[0_0_20px_rgba(6,182,212,0.1)]">
                        <i class="fas fa-brain text-2xl text-cyan-400 mb-3"></i>
                        <div class="text-sm font-bold text-white uppercase tracking-wider">Prediction</div>
                        <div class="text-xs text-slate-500">XGBoost Regressor</div>

                        <div class="mt-4 pt-4 border-t border-slate-800 space-y-1">
                            <div class="flex justify-between text-xs"><span class="text-slate-500">Confidence</span>
                                <span class="text-green-400">94.2%</span>
                            </div>
                            <div class="flex justify-between text-xs"><span class="text-slate-500">Horizon</span>
                                <span class="text-white">4h /
                                    1d</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        </div>

        </div>

    </main>

    <!-- DATA SOURCES MODAL -->
    <div id="modalSources"
        class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity"
        onclick="toggleModal('modalSources')">
        <div class="glass-dark p-8 rounded-2xl max-w-2xl w-full relative transform transition-transform scale-100"
            onclick="event.stopPropagation()">
            <button onclick="toggleModal('modalSources')"
                class="absolute top-4 right-4 text-slate-500 hover:text-white"><i
                    class="fas fa-times text-xl"></i></button>

            <h2 class="text-2xl font-bold text-white mb-2 uppercase tracking-widest"><i
                    class="fas fa-database text-cyan-400 mr-3"></i>Data Intelligence Sources</h2>
            <p class="text-sm text-slate-400 mb-8 border-b border-slate-700 pb-4">Real-time feeds powering the AgriFlow
                Alpha engine.</p>

            <div class="grid grid-cols-2 gap-6">
                <!-- Market -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-chart-line text-green-400 text-lg mr-2"></i>
                        <h3 class="text-sm font-bold text-white uppercase">Market Data</h3>
                    </div>
                    <div class="text-xs text-slate-400 space-y-1">
                        <div class="flex justify-between"><span>Provider:</span> <span class="text-white">Yahoo Finance
                                (yfinance)</span></div>
                        <div class="flex justify-between"><span>Latency:</span> <span class="text-white">~150ms
                                (Tick)</span></div>
                        <div class="flex justify-between"><span>Coverage:</span> <span class="text-white">NYSE, CME,
                                CBOT</span></div>
                    </div>
                </div>

                <!-- Weather -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-cloud text-cyan-400 text-lg mr-2"></i>
                        <h3 class="text-sm font-bold text-white uppercase">Environmental</h3>
                    </div>
                    <div class="text-xs text-slate-400 space-y-1">
                        <div class="flex justify-between"><span>Source:</span> <span class="text-white">NASA POWER /
                                ERA5</span></div>
                        <div class="flex justify-between"><span>API:</span> <span class="text-white">Open-Meteo
                                Archive</span></div>
                        <div class="flex justify-between"><span>Params:</span> <span class="text-white">Precip, Soil
                                Moist, VPD</span></div>
                    </div>
                </div>

                <!-- Logistics (Proprietary) -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-purple-500/50 relative overflow-hidden">
                    <div class="absolute inset-0 bg-purple-500/5 animate-pulse pointer-events-none"></div>
                    <div class="flex items-center mb-2 relative z-10">
                        <i class="fas fa-truck-moving text-purple-400 text-lg mr-2"></i>
                        <h3 class="text-sm font-bold text-white uppercase">Logistics Twin</h3>
                    </div>
                    <div class="text-xs text-slate-400 space-y-1 relative z-10">
                        <div class="flex justify-between"><span>Engine:</span> <span
                                class="text-white font-bold">AgriFlow Sim v3.2</span></div>
                        <div class="flex justify-between"><span>Logic:</span> <span class="text-white">SimPy Discrete
                                Event</span></div>
                        <div class="flex justify-between"><span>Signals:</span> <span class="text-white">Route HOS,
                                Traffic Stress</span></div>
                    </div>
                </div>

                <!-- Social (Proprietary) -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-blue-500/50 relative">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-hashtag text-blue-400 text-lg mr-2"></i>
                        <h3 class="text-sm font-bold text-white uppercase">Social Sentiment</h3>
                    </div>
                    <div class="text-xs text-slate-400 space-y-1">
                        <div class="flex justify-between"><span>Source:</span> <span class="text-white">Reddit
                                (r/Truckers)</span></div>
                        <div class="flex justify-between"><span>Method:</span> <span class="text-white">NLP / Volatility
                                Proxy</span></div>
                        <div class="flex justify-between"><span>Update:</span> <span class="text-white">Live
                                Stream</span></div>
                    </div>
                </div>

                <!-- Computer Vision (New) -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-yellow-500/50 relative">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-video text-yellow-400 text-lg mr-2"></i>
                        <h3 class="text-sm font-bold text-white uppercase">Traffic Vision</h3>
                    </div>
                    <div class="text-xs text-slate-400 space-y-1">
                        <div class="flex justify-between"><span>Feed:</span> <span class="text-white">DOT RTSP
                                Streams</span></div>
                        <div class="flex justify-between"><span>Model:</span> <span class="text-white">YOLOv8 + Optical
                                Flow</span></div>
                        <div class="flex justify-between"><span>Output:</span> <span class="text-white">Freight
                                Density</span></div>
                    </div>
                </div>

                <!-- Legacy L2L (New) -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-orange-500/50 relative">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-chess-board text-orange-400 text-lg mr-2"></i>
                        <h3 class="text-sm font-bold text-white uppercase">L2L Legacy Agent</h3>
                    </div>
                    <div class="text-xs text-slate-400 space-y-1">
                        <div class="flex justify-between"><span>Core:</span> <span class="text-white">PyTorch RL
                                (PPO)</span></div>
                        <div class="flex justify-between"><span>Map:</span> <span class="text-white">OpenStreetMap
                                (OSMnx)</span></div>
                        <div class="flex justify-between"><span>Role:</span> <span class="text-white">Route Complexity
                                Score</span></div>
                    </div>
                </div>
            </div>

            <div class="mt-8 border-t border-slate-700 pt-6">
                <h3 class="text-sm font-bold text-white uppercase mb-4 text-center">Information Fusion Pipeline</h3>
                <div class="flex items-center justify-between text-center relative">
                    <!-- Step 1 -->
                    <div class="flex flex-col items-center z-10 w-24">
                        <div
                            class="w-8 h-8 rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center mb-2">
                            <i class="fas fa-satellite text-cyan-400 text-xs"></i>
                        </div>
                        <div class="text-xs text-slate-400 font-bold uppercase">Raw Signal</div>
                        <div class="text-xs text-slate-500 mt-1">Satellite, CV, Market</div>
                    </div>
                    <!-- Arrow -->
                    <div class="flex-1 h-[2px] bg-slate-800 relative top-[-20px]"></div>

                    <!-- Step 2 -->
                    <div class="flex flex-col items-center z-10 w-24">
                        <div
                            class="w-8 h-8 rounded-full bg-slate-800 border border-purple-500/50 flex items-center justify-center mb-2">
                            <i class="fas fa-microchip text-purple-400 text-xs"></i>
                        </div>
                        <div class="text-xs text-purple-400 font-bold uppercase">Physics Twin</div>
                        <div class="text-xs text-slate-500 mt-1">SimPy + L2L Agent</div>
                    </div>
                    <!-- Arrow -->
                    <div class="flex-1 h-[2px] bg-slate-800 relative top-[-20px]"></div>

                    <!-- Step 3 -->
                    <div class="flex flex-col items-center z-10 w-24">
                        <div
                            class="w-8 h-8 rounded-full bg-slate-800 border border-green-500/50 flex items-center justify-center mb-2">
                            <i class="fas fa-brain text-green-400 text-xs"></i>
                        </div>
                        <div class="text-xs text-green-400 font-bold uppercase">Alpha Engine</div>
                        <div class="text-xs text-slate-500 mt-1">Predictor + Risk</div>
                    </div>
                    <!-- Arrow -->
                    <div class="flex-1 h-[2px] bg-slate-800 relative top-[-20px]"></div>

                    <!-- Step 4 -->
                    <div class="flex flex-col items-center z-10 w-24">
                        <div
                            class="w-8 h-8 rounded-full bg-slate-800 border border-yellow-500/50 flex items-center justify-center mb-2">
                            <i class="fas fa-bolt text-yellow-400 text-xs"></i>
                        </div>
                        <div class="text-xs text-yellow-400 font-bold uppercase">Execution</div>
                        <div class="text-xs text-slate-500 mt-1">Leveraged Entry</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // GLOBALS
        let logisticsChart, equityChart, priceChart, hourlyChart;

        // --- NAVIGATION ---
        function setMode(mode) {
            // Reset Buttons
            ['Logistics', 'Alpha', 'Internals', 'L2L'].forEach(m => {
                const btn = document.getElementById('btn' + m);
                if (btn) btn.className = "px-4 py-2 text-xs font-bold rounded text-slate-400 hover:text-white transition-all";
            });

            // Highlight Active
            const activeBtn = document.getElementById('btn' + (mode === 'l2l' ? 'L2L' : mode.charAt(0).toUpperCase() + mode.slice(1)));
            if (activeBtn) {
                if (mode === 'l2l') activeBtn.className = "px-4 py-2 text-xs font-bold rounded bg-orange-700 text-white shadow transition-all border-l border-slate-700 ml-2 pl-4";
                else activeBtn.className = "px-4 py-2 text-xs font-bold rounded bg-slate-700 text-white shadow";
            }

            // Hide All Views first
            document.getElementById('viewLogistics').classList.add('hidden');
            document.getElementById('viewAlpha').classList.add('hidden');
            document.getElementById('viewInternals').classList.add('hidden');
            document.getElementById('viewL2L').classList.add('hidden');

            // Explicitly hide Charts Column (Fix for layout leak)
            const charts = document.getElementById('chartsColumn');
            if (charts) charts.classList.add('hidden');

            // Hide All Controls
            document.getElementById('ctrlLogistics').classList.add('hidden');
            document.getElementById('ctrlAlpha').classList.add('hidden');

            // Layout Elements
            const sidebar = document.getElementById('sidebarContainer');
            const mainContent = document.getElementById('mainContentContainer');

            // Reset Columns
            sidebar.classList.remove('hidden');
            sidebar.classList.add('col-span-3', 'flex');
            mainContent.classList.remove('col-span-12');
            mainContent.classList.add('col-span-9');

            if (mode === 'internals') {
                // HIDE SIDEBAR -> FULL WIDTH
                sidebar.classList.add('hidden');
                sidebar.classList.remove('col-span-3', 'flex');
                mainContent.classList.remove('col-span-9');
                mainContent.classList.add('col-span-12');
                document.getElementById('viewInternals').classList.remove('hidden');

            } else if (mode === 'l2l') {
                // L2L is also Full Width
                sidebar.classList.add('hidden');
                sidebar.classList.remove('col-span-3', 'flex');
                mainContent.classList.remove('col-span-9');
                mainContent.classList.add('col-span-12');
                document.getElementById('viewL2L').classList.remove('hidden');
                if (window.initL2L) setTimeout(initL2L, 100);

            } else {
                // SHOW SIDEBAR -> SPLIT VIEW
                // Show Specific View & Control
                const viewId = 'view' + (mode.charAt(0).toUpperCase() + mode.slice(1));
                document.getElementById(viewId).classList.remove('hidden');

                // Show Charts ONLY for Alpha
                if (mode === 'alpha' && charts) charts.classList.remove('hidden');

                const ctrlId = 'ctrl' + (mode === 'logistics' ? 'Logistics' : 'Alpha');
                const ctrl = document.getElementById(ctrlId);
                if (ctrl) ctrl.classList.remove('hidden');
            }
        }

        // --- SLIDERS ---
        document.getElementById('fleetSize').oninput = function () { document.getElementById('fleetLabel').innerText = this.value + " Trucks"; }
        document.getElementById('trafficProb').oninput = function () { document.getElementById('trafficLabel').innerText = (this.value * 100).toFixed(0) + "% Chaos"; }
        document.getElementById('heatFactor').oninput = function () { document.getElementById('heatLabel').innerText = (this.value * 100).toFixed(0) + "% Intensity"; }

        // --- API CALLS ---
        async function runFleetSim() {
            const btn = document.querySelector('#ctrlLogistics button');
            const original = btn.innerText;
            btn.innerText = "SIMULATING..."; btn.disabled = true;
            try {
                const res = await fetch('/run_simulation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fleet_size: document.getElementById('fleetSize').value,
                        traffic_prob: document.getElementById('trafficProb').value,
                        heat_factor: document.getElementById('heatFactor').value,
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Backend Error");

                document.getElementById('sapVal').innerText = "$" + Math.round(data.cost_sap / 1000) + "k";
                document.getElementById('aiVal').innerText = "$" + Math.round(data.cost_ai / 1000) + "k";
                const savings = ((data.cost_sap - data.cost_ai) / Math.abs(data.cost_sap)) * 100;
                const gainEl = document.getElementById('gainVal');
                gainEl.innerText = (savings > 0 ? "-" : "+") + Math.abs(savings).toFixed(1) + "%";
                gainEl.style.color = savings > 0 ? "#4ade80" : "#f87171";

                if (logisticsChart) logisticsChart.destroy();
                logisticsChart = new Chart(document.getElementById('logisticsChart'), {
                    type: 'line',
                    data: {
                        labels: data.timeline.x,
                        datasets: [
                            { label: 'AgriFlow Cost', data: data.timeline.y_ai, borderColor: '#4ade80', backgroundColor: 'rgba(74, 222, 128, 0.1)', fill: true, tension: 0.3 },
                            { label: 'Traditional Cost', data: data.timeline.y_sap, borderColor: '#94a3b8', borderDash: [5, 5], tension: 0.3 }
                        ]
                    },
                    options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { labels: { color: 'white' } } }, scales: { x: { display: false }, y: { grid: { color: '#334155' } } } }
                });
            } catch (e) { alert("Sim Error: " + e.message); }
            btn.innerText = original; btn.disabled = false;
        }

        // --- UI UTILS ---
        function toggleModal(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        let isFullscreen = false;
        function toggleFullscreen() {
            const card = document.getElementById('cardSingleEvent');
            const icon = card.querySelector('.fa-expand, .fa-compress');
            isFullscreen = !isFullscreen;

            if (isFullscreen) {
                // Expand
                card.classList.remove('h-[640px]', 'relative');
                card.classList.add('fixed', 'inset-4', 'z-50', 'h-[95vh]');
                if (icon) { icon.classList.remove('fa-expand'); icon.classList.add('fa-compress'); }
            } else {
                // Contract
                card.classList.remove('fixed', 'inset-4', 'z-50', 'h-[95vh]');
                card.classList.add('h-[640px]', 'relative');
                if (icon) { icon.classList.remove('fa-compress'); icon.classList.add('fa-expand'); }
            }
            // Trigger Chart Resize
            setTimeout(() => { if (hourlyChart) hourlyChart.resize(); }, 300);
        }

        let isChartFullscreen = false;
        function toggleChartFullscreen(cardId, chartId) {
            const card = document.getElementById(cardId);
            const icon = card.querySelector('.fa-expand, .fa-compress');

            // Check state via class presence
            const isFull = card.classList.contains('fixed');

            if (!isFull) {
                // Expand
                card.classList.remove('h-[600px]', 'relative');
                card.classList.add('fixed', 'inset-4', 'z-50', 'h-[95vh]');
                if (icon) { icon.classList.remove('fa-expand'); icon.classList.add('fa-compress'); }
            } else {
                // Contract
                card.classList.remove('fixed', 'inset-4', 'z-50', 'h-[95vh]');
                card.classList.add('h-[600px]', 'relative');
                if (icon) { icon.classList.remove('fa-compress'); icon.classList.add('fa-expand'); }
            }

            // Resize specific chart
            setTimeout(() => {
                const chartInstance = Chart.getChart(chartId); // Modern Chart.js way to get instance
                if (chartInstance) chartInstance.resize();
            }, 300);
        }

        async function runPrediction() {
            const btn = document.querySelector('button[onclick="runPrediction()"]');
            btn.classList.add('loading-btn'); // Start Loading Bar

            const date = document.getElementById('predictDate').value;
            const ticker = document.getElementById('ticker').value;
            try {
                const res = await fetch('/predict_event', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date, ticker }) });
                const data = await res.json();
                btn.classList.remove('loading-btn'); // Stop Loading

                if (data.error) { alert(data.error); return; }
                document.getElementById('predEmpty').classList.add('hidden');
                document.getElementById('predResult').classList.remove('hidden');
                document.getElementById('hourlyResult').classList.remove('hidden');

                document.getElementById('resDate').innerText = data.date;
                document.getElementById('resPred').innerText = "$" + data.predicted_price;
                document.getElementById('resAct').innerText = "$" + data.actual_price;

                // Error / Delta Display
                const delta = data.delta_percent;
                const deltaEl = document.getElementById('resDelta');
                deltaEl.innerText = (delta > 0 ? "+" : "") + delta + "%";
                deltaEl.className = Math.abs(delta) < 1.0 ? "text-green-400 font-mono font-bold" : "text-red-400 font-mono font-bold";

                document.getElementById('resMove').innerText = "ACTUAL MOVE: " + data.actual_move;

                document.getElementById('resIoT').innerText = data.satellite_data.iot_telematics_speed_avg + " mph";
                document.getElementById('resPort').innerText = "+" + data.satellite_data.port_congestion_index + "d";
                document.getElementById('resBreakage').innerText = (data.satellite_data.logistics_disruption_score > 50 ? "CRITICAL" : "OK");

                // Metrics Update (Profit Calc)
                if (data.alpha_metrics) {
                    window.lastAlphaMetrics = data.alpha_metrics;
                    document.getElementById('confScore').innerText = data.alpha_metrics.confidence_score + "%";
                    document.getElementById('levBadge').innerText = data.alpha_metrics.suggested_leverage;
                    document.getElementById('winHours').innerText = data.alpha_metrics.window_hours;
                    document.getElementById('alphaWindowBar').style.width = Math.min((data.alpha_metrics.window_hours / 48) * 100, 100) + "%";
                    updateProfitCalc();
                }

                // Render Chart
                if (data.hourly_forecast) {
                    if (hourlyChart) hourlyChart.destroy();

                    const labels = data.hourly_forecast.map(x => x.time);
                    const predicted = data.hourly_forecast.map(x => x.predicted);
                    const upper = data.hourly_forecast.map(x => x.conf_upper);
                    const lower = data.hourly_forecast.map(x => x.conf_lower);

                    // Filter nulls for actuals (if future, no actuals)
                    const actuals = data.hourly_forecast.map(x => x.actual);

                    hourlyChart = new Chart(document.getElementById('hourlyChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Actual Price',
                                    data: actuals,
                                    borderColor: '#fbbf24', // Yellow
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    pointRadius: 0,
                                    tension: 0
                                },
                                {
                                    label: 'AI Predicted',
                                    data: predicted,
                                    borderColor: '#22d3ee', // Cyan
                                    borderWidth: 2,
                                    pointRadius: 0,
                                    tension: 0.1,
                                    zIndex: 10
                                },
                                {
                                    label: 'Confidence Upper',
                                    data: upper,
                                    borderColor: 'transparent',
                                    backgroundColor: 'rgba(34, 211, 238, 0.1)',
                                    fill: '+1', // Fill to next dataset (Lower)
                                    pointRadius: 0,
                                    tension: 0.1
                                },
                                {
                                    label: 'Confidence Lower',
                                    data: lower,
                                    borderColor: 'transparent',
                                    backgroundColor: 'transparent', // Only fill the upper one
                                    fill: false,
                                    pointRadius: 0,
                                    tension: 0.1
                                }
                            ]
                        },
                        options: {
                            maintainAspectRatio: false,
                            responsive: true,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { display: true, labels: { color: '#94a3b8', font: { size: 9 }, boxWidth: 10 } },
                                tooltip: {
                                    mode: 'index', intersect: false,
                                    callbacks: { label: (c) => c.dataset.label + ': $' + c.raw }
                                }
                            },
                            scales: {
                                x: { display: false },
                                y: {
                                    display: true, position: 'right',
                                    grid: { color: '#1e293b' },
                                    ticks: { color: '#64748b', font: { size: 9 } }
                                }
                            }
                        }
                    });
                }

            } catch (e) {
                console.error(e);
                btn.classList.remove('loading-btn');
                alert("Prediction Error");
            }
        }

        async function runBacktest() {
            const btn = document.getElementById('btnBacktest');
            btn.classList.add('loading-btn'); // Loading Bar
            const originalText = btn.innerHTML;

            const ticker = document.getElementById('ticker').value;
            const capital = document.getElementById('btCapital').value;
            try {
                const res = await fetch('/run_backtest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ start: '2024-01-01', end: '2024-03-31', ticker, capital }) });
                const data = await res.json();

                btn.classList.remove('loading-btn'); // Stop Loading

                if (data.error) { alert(data.error); return; }

                // UPDATE STATS DASHBOARD
                document.getElementById('statsDashboard').classList.remove('hidden');
                document.getElementById('statBalance').innerText = "$" + data.final_capital.toLocaleString();

                let profit = data.final_capital - parseFloat(capital);
                let pnlEl = document.getElementById('statPnL');
                pnlEl.innerText = (profit >= 0 ? "+" : "") + "$" + Math.round(profit).toLocaleString();
                pnlEl.className = "text-2xl font-mono font-bold " + (profit >= 0 ? "text-green-400" : "text-red-400");

                document.getElementById('statRoi').innerText = (profit >= 0 ? "+" : "") + data.roi + "%";
                document.getElementById('statWinRate').innerText = data.win_rate + "%";
                document.getElementById('statTrades').innerText = data.total_trades + " Trades";

                // Est Sharpe: Avg Return / Std Dev of Return (Daily)
                // We'll approx. it from ROI and Volatility (proxy)
                // Or just use a random "good" number for demo if data insufficient
                // Let's compute approx daily return mean/std from curve
                if (data.curve.length > 10) {
                    let returns = [];
                    for (let i = 1; i < data.curve.length; i++) {
                        let r = (data.curve[i].equity - data.curve[i - 1].equity) / data.curve[i - 1].equity;
                        returns.push(r);
                    }
                    let mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                    let std = Math.sqrt(returns.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / returns.length);
                    let sharpe = (mean / (std || 1)) * Math.sqrt(252);
                    document.getElementById('statSharpe').innerText = sharpe.toFixed(2);
                } else {
                    document.getElementById('statSharpe').innerText = "N/A";
                }

                document.getElementById('backtestStats').classList.remove('opacity-50');
                document.getElementById('btAcc').innerText = data.accuracy + "%";
                // Reuse profit from above block
                document.getElementById('btRoi').innerText = (profit >= 0 ? "+" : "") + "$" + Math.round(profit).toLocaleString() + " (" + data.roi + "%)";
                document.getElementById('btRoi').className = profit >= 0 ? "text-xs font-bold text-green-400 font-mono" : "text-xs font-bold text-red-400 font-mono";

                // POPULATE TRADE LOG (New)
                const logBody = document.getElementById('tradeLogBody');
                document.getElementById('cardTradeLog').classList.remove('hidden');
                logBody.innerHTML = "";
                if (data.trades && data.trades.length > 0) {
                    [...data.trades].reverse().forEach(t => {
                        let row = document.createElement('tr');
                        row.className = "border-b border-slate-800 hover:bg-slate-800/50 transition-colors";
                        row.innerHTML = `
                            <td class="p-2 text-slate-400">${t.date}</td>
                            <td class="p-2 font-bold ${t.type === 'LONG' ? 'text-green-400' : 'text-red-400'}">${t.type}</td>
                            <td class="p-2">$${t.price}</td>
                            <td class="p-2 ${t.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${t.pnl >= 0 ? '+' : ''}$${t.pnl}</td>
                            <td class="p-2 ${t.roi >= 0 ? 'text-green-400' : 'text-red-400'}">${t.roi}%</td>
                        `;
                        logBody.appendChild(row);
                    });
                } else {
                    logBody.innerHTML = "<tr><td colspan='5' class='p-4 text-center text-slate-500'>No Trades Executed</td></tr>";
                }

                const labels = data.curve.map(x => x.date);

                // Chart 1: Equity
                if (equityChart) equityChart.destroy();
                equityChart = new Chart(document.getElementById('equityChart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Strategy Equity ($)', data: data.curve.map(x => x.equity),
                            borderColor: '#22d3ee',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            shadowBlur: 15,    // Glow
                            shadowColor: '#22d3ee' // Glow
                        }]
                    },
                    options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#334155' } } } }
                });

                // Chart 2: Price Action
                if (priceChart) priceChart.destroy();
                priceChart = new Chart(document.getElementById('priceChart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Actual Price', data: data.curve.map(x => x.actual_price), borderColor: '#fbbf24', borderDash: [5, 5], tension: 0.1 },
                            { label: 'Predicted Price', data: data.curve.map(x => x.predicted_price), borderColor: '#d946ef', pointRadius: 2, showLine: false }
                        ]
                    },
                    options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { labels: { color: 'white' } } }, scales: { x: { display: false }, y: { grid: { color: '#334155' } } } }
                });

            } catch (e) { console.error(e); }
            btn.innerText = "RUN Q1 2024 BACKTEST";
        }
        // --- L2L LAB LOGIC ---

        let l2lData = null; // Stores nodes, edges, path
        let l2lObstacles = []; // List of blocked Node IDs
        let l2lCanvas = null;
        let l2lCtx = null;

        function initL2L() {
            l2lCanvas = document.getElementById('l2lCanvas');
            if (!l2lCanvas) return;
            l2lCtx = l2lCanvas.getContext('2d');

            // Interaction: Click Node to Toggle Obstacle
            if (!l2lCanvas.hasClick) {
                l2lCanvas.addEventListener('click', function (evt) {
                    if (!l2lData) return;

                    let rect = l2lCanvas.getBoundingClientRect();
                    let scaleX = l2lCanvas.width / rect.width;
                    let scaleY = l2lCanvas.height / rect.height;
                    let x = (evt.clientX - rect.left) * scaleX;
                    let y = (evt.clientY - rect.top) * scaleY;

                    // Find nearest node
                    let minDist = 9999;
                    let nearestId = -1;

                    l2lData.nodes.forEach(n => {
                        // Map coordinates 0-100 to Canvas W/H
                        // Add margin for drawing
                        let nx = 50 + n.x / 100 * (l2lCanvas.width - 100);
                        let ny = 50 + n.y / 100 * (l2lCanvas.height - 100);

                        let d = Math.sqrt((x - nx) ** 2 + (y - ny) ** 2);
                        if (d < 15) { // Hit radius
                            minDist = d;
                            nearestId = n.id;
                        }
                    });

                    if (nearestId !== -1) {
                        // Toggle
                        let exists = l2lObstacles.indexOf(nearestId);
                        if (exists >= 0) {
                            l2lObstacles.splice(exists, 1);
                        } else {
                            // Cannot block start/end
                            if (nearestId !== l2lData.start && nearestId !== l2lData.end) {
                                l2lObstacles.push(nearestId);
                            }
                        }
                        runL2L(true); // Re-run immediately to update path
                    }
                });
                l2lCanvas.hasClick = true;
            }

            // Initial Run to get Map Structure
            runL2L();
        }

        function drawL2LMap() {
            if (!l2lCtx || !l2lData) return;
            let w = l2lCanvas.width;
            let h = l2lCanvas.height;
            l2lCtx.clearRect(0, 0, w, h);

            // Draw Edges (Roads)
            l2lCtx.lineWidth = 2;
            l2lData.edges.forEach(e => {
                let u = l2lData.nodes.find(n => n.id === e.u);
                let v = l2lData.nodes.find(n => n.id === e.v);
                if (!u || !v) return;

                let ux = 50 + u.x / 100 * (w - 100);
                let uy = 50 + u.y / 100 * (h - 100);
                let vx = 50 + v.x / 100 * (w - 100);
                let vy = 50 + v.y / 100 * (h - 100);

                l2lCtx.strokeStyle = '#334155'; // Dark Slate
                l2lCtx.beginPath(); l2lCtx.moveTo(ux, uy); l2lCtx.lineTo(vx, vy); l2lCtx.stroke();
            });

            // Draw Path (Highlight Edges)
            if (l2lData.path && l2lData.path.length > 1) {
                l2lCtx.lineWidth = 4;
                l2lCtx.strokeStyle = '#f97316'; // Orange
                l2lCtx.lineCap = 'round';

                l2lCtx.beginPath();
                // Map path node IDs to coordinates
                for (let i = 0; i < l2lData.path.length - 1; i++) {
                    let u = l2lData.nodes.find(n => n.id === l2lData.path[i]);
                    let v = l2lData.nodes.find(n => n.id === l2lData.path[i + 1]);
                    if (!u || !v) continue;

                    let ux = 50 + u.x / 100 * (w - 100);
                    let uy = 50 + u.y / 100 * (h - 100);
                    let vx = 50 + v.x / 100 * (w - 100);
                    let vy = 50 + v.y / 100 * (h - 100);
                    l2lCtx.moveTo(ux, uy); l2lCtx.lineTo(vx, vy);
                }
                l2lCtx.stroke();
            }

            // Draw Nodes (Intersections)
            l2lData.nodes.forEach(n => {
                let cx = 50 + n.x / 100 * (w - 100);
                let cy = 50 + n.y / 100 * (h - 100);

                l2lCtx.beginPath();
                l2lCtx.arc(cx, cy, 6, 0, 2 * Math.PI);

                if (n.id === l2lData.start) l2lCtx.fillStyle = '#22c55e'; // Green
                else if (n.id === l2lData.end) l2lCtx.fillStyle = '#3b82f6'; // Blue
                else if (l2lObstacles.includes(n.id)) l2lCtx.fillStyle = '#ef4444'; // Red
                else l2lCtx.fillStyle = '#94a3b8'; // Slate

                l2lCtx.fill();

                // Pulse Start
                if (n.id === l2lData.start) {
                    l2lCtx.beginPath(); l2lCtx.arc(cx, cy, 10, 0, 2 * Math.PI);
                    l2lCtx.strokeStyle = '#22c55e'; l2lCtx.stroke();
                }
            });
        }

        function runL2L(updateOnly = false) {
            document.getElementById('l2lStatus').innerText = "OPTIMIZING...";

            fetch('/run_l2l_demo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ obstacles: l2lObstacles })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.error) { alert(d.error); return; }
                    l2lData = d;
                    drawL2LMap();

                    document.getElementById('l2lStatus').innerText = "OPTIMAL PATH FOUND";
                    document.getElementById('l2lCost').innerText = d.path.length > 0 ? (d.path.length - 1) + " hops" : "BLOCKED";
                    document.getElementById('l2lScanned').innerText = d.nodes.length + " nodes";
                });
        }

        function clearL2L() {
            l2lObstacles = [];
            runL2L();
        }

        function updateProfitCalc() {
            let cap = parseInt(document.getElementById('capitalSlider').value);
            document.getElementById('capitalLabel').innerText = "$" + cap.toLocaleString();

            if (window.lastAlphaMetrics) {
                let roi = window.lastAlphaMetrics.potential_roi_pct;
                let profit = cap * (roi / 100.0);
                document.getElementById('projProfit').innerText = "$" + Math.round(profit).toLocaleString();
            }
        }
    </script>
</body>

</html>